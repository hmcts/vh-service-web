# Set variables once
variables:
  - group: KinlyConfiguration

  - name: SelfTestApiKey
    value: $(SelfTestApiKey_test)
  - name: KinlyApiKey
    value: $(KinlyApiKey_test)
  - name: KinlyApiAudience
    value: $(KinlyApiAudience)
  - name: KinlyApiIssuer
    value: $(KinlyApiIssuer)
  - name: cleanChekout
    value: false
  

  - name: apiDirectory
    value: ServiceWebsite/ServiceWebsite
  - name: solutionType
    value: angularDotNetCore # angularDotNetCore, dotNetCore

  - name: sonarCloudPrepareExtraProperties
    value: |  
      sonar.exclusions=**/node_modules/**, **/*.spec.ts, *.spec.ts, **/ClientApp/*, **/ClientApp/src/*, **/ClientApp/coverage/**/*, **/*.js, **/ServiceWebsite/Security/*.cs,**/ServiceWebsite/Swagger/*.cs,**/ConfigureServicesExtensions.cs, **/Startup.cs, **/Program.cs
      sonar.typescript.lcov.reportPaths=$(System.DefaultWorkingDirectory)/ServiceWebsite/ServiceWebsite/ClientApp/coverage/lcov.info, **/lcov.info
      sonar.typescript.exclusions=**/node_modules/**, **/typings.d.ts, **/main.ts, **/environments/environment*.ts, **/*routing.module.ts, **/api-client.ts
      sonar.cs.opencover.reportsPaths=$(Common.TestResultsDirectory)\Coverage\coverage.opencover.xml

  - name: coverletCoverageExclusions
    value: '[ServiceWebsite.BookingApi.Client]*,[ServiceWebsite.UserAPI.Client]*,[ServiceWebsite.VideoAPI.Client]*,[*]ServiceWebsite.Swagger.*,[ServiceWebsite]ServiceWebsite.Program,[ServiceWebsite]ServiceWebsite.Startup,[ServiceWebsite]ServiceWebsite.ConfigureServicesExtensions,[*]ServiceWebsite.AcceptanceTests/*'
  
  - name: integrationTestsAppSettingsTransform
    value: '
      "AzureAd/TenantId":"$(tenantid)",
      "KinlyConfiguration/ApiSecret":"$(KinlyApiKey)",
      "KinlyConfiguration/SelfTestApiSecret":"$(SelfTestApiKey)",
      "KinlyConfiguration/Audience":"$(KinlyApiAudience)",
      "KinlyConfiguration/Issuer":"$(KinlyApiIssuer)"
      '
  - name: keyVaultName
    value: vhcoreinfrahtdev # Used to get secrets for integration tests
  - name: secretsFilter
    value:  'TenantId' # filters out secrets returned from key vault

# GitHub Repo that contains build templates. Reference https://docs.microsoft.com/en-us/azure/devops/pipelines/process/templates?view=vsts#using-other-repositories
resources:
  repositories:
  - repository: azureDevOpsTemplates
    type: github
    name: hmcts/azure-devops-templates
    endpoint: hmcts

trigger:
  branches:
    include:
    - master
    - release/*
    - hotfix/*
pr:
  - master

jobs:
- template: jobs/angularDotNetCore.yml@azureDevOpsTemplates # Template reference
  parameters:
    cleanCheckout: $(cleanCheckout)
    sonarCloudExtraProperties: $(sonarCloudPrepareExtraProperties)
    KeyVaultName: $(KeyVaultName)
    apiDirectory: $(apiDirectory)
    SecretsFilter: $(SecretsFilter)
    solutionType: $(solutionType)
    integrationTestsAppSettingsTransform: $(integrationTestsAppSettingsTransform)
    dotNetCoreVersion: '3.1.100'
    nodeVersion: '10.x'
